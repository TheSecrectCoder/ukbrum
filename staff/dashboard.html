<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard - UKBRUM</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/staff-dashboard.css">
    <link rel="stylesheet" href="../css/new-sidebar.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../js/script.js" defer></script>
    <script src="../js/staff-dashboard.js" defer></script>
    <script src="../js/api-functions.js" defer></script>
    <script src="../js/save-settings.js" defer></script>
    <script src="dashboard-functions.js" defer></script>
    <script src="load-settings-js.js" defer></script>
    <script src="settings-handler.js" defer></script>
</head>
<body>
    <header class="dashboard-header">
        <div class="container">
            <div class="logo">
                <a href="../index.html">
                    <img src="../images/logo.png" alt="UKBRUM Logo">
                    <h1><span class="full-name">Staff Dashboard</span><span class="short-name">Dashboard</span></h1>
                </a>
            </div>
            <div class="user-menu">
                <div class="user-info">
                    <span class="user-role" id="userRole">Role</span>
                    <span class="user-name" id="userName">Username</span>
                </div>
                <div class="theme-toggle">
                    <button id="theme-toggle-btn" aria-label="Toggle dark/light mode">
                        <i class="fas fa-sun"></i>
                    </button>
                </div>
                <button id="logoutBtn" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <ul>
                    <li class="active">
                        <a href="#overview" data-section="overview">
                            <i class="fas fa-tachometer-alt"></i> Overview
                        </a>
                    </li>
                    <li>
                        <a href="#reports" data-section="reports">
                            <i class="fas fa-flag"></i> Reports
                            <span class="badge" id="reportsCount">0</span>
                        </a>
                    </li>
                    <!-- Activity Log section removed as requested -->
                    <li>
                        <a href="#staff-notes" data-section="staff-notes">
                            <i class="fas fa-sticky-note"></i> Staff Notes
                        </a>
                    </li>
                    <li id="adminSection" style="display: none;">
                        <a href="#admin" data-section="admin">
                            <i class="fas fa-user-shield"></i> Admin Panel
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <!-- Overview Section -->
            <section id="overview" class="dashboard-section active">
                <h2>Dashboard Overview</h2>
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-flag"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Pending Reports</h3>
                            <p class="stat-value" id="pendingReportsCount">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Resolved Reports</h3>
                            <p class="stat-value" id="resolvedReportsCount">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Activity Logs</h3>
                            <p class="stat-value" id="activityLogsCount">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Staff Online</h3>
                            <p class="stat-value" id="staffOnlineCount">1</p>
                        </div>
                    </div>
                </div>

                <div class="recent-activity">
                    <h3>Recent Activity</h3>
                    <div class="activity-list" id="recentActivityList">
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-sign-in-alt"></i>
                            </div>
                            <div class="activity-details">
                                <p class="activity-text">You logged into the staff dashboard</p>
                                <p class="activity-time">Just now</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports" class="dashboard-section">
                <h2>Reports Management</h2>
                <div class="filter-bar">
                    <div class="filter-group">
                        <label for="reportStatusFilter">Status:</label>
                        <select id="reportStatusFilter">
                            <option value="all">All</option>
                            <option value="pending">Pending</option>
                            <option value="in-progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="reportTypeFilter">Type:</label>
                        <select id="reportTypeFilter">
                            <option value="all">All Types</option>
                            <option value="player">Player Report</option>
                            <option value="bug">Bug Report</option>
                            <option value="suggestion">Suggestion</option>
                            <option value="appeal">Ban Appeal</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="search-group">
                        <input type="text" id="reportSearch" placeholder="Search reports...">
                        <button id="searchBtn"><i class="fas fa-search"></i></button>
                    </div>
                </div>

                <div class="reports-table-container">
                    <table class="reports-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Type</th>
                                <th>Title</th>
                                <th>Submitted By</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <!-- Reports will be loaded here -->
                            <tr class="no-reports-row">
                                <td colspan="7">No reports found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Report Detail Modal -->
            <div id="reportModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modalReportTitle">Report Details</h3>
                        <button class="close-modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="report-details">
                            <div class="detail-group">
                                <label>Report ID:</label>
                                <span id="modalReportId"></span>
                            </div>
                            <div class="detail-group">
                                <label>Type:</label>
                                <span id="modalReportType"></span>
                            </div>
                            <div class="detail-group">
                                <label>Submitted By:</label>
                                <span id="modalReportUser"></span>
                            </div>
                            <div class="detail-group">
                                <label>Discord Tag:</label>
                                <span id="modalReportDiscord"></span>
                            </div>
                            <div class="detail-group">
                                <label>Date:</label>
                                <span id="modalReportDate"></span>
                            </div>
                            <div class="detail-group">
                                <label>Status:</label>
                                <span id="modalReportStatus"></span>
                            </div>
                            <div class="detail-group full-width">
                                <label>Details:</label>
                                <div id="modalReportDetails" class="report-content"></div>
                            </div>
                            <div class="detail-group full-width">
                                <label>Evidence:</label>
                                <div id="modalReportEvidence" class="report-content"></div>
                            </div>
                        </div>

                        <div class="report-actions">
                            <h4>Update Status</h4>
                            <div class="status-buttons">
                                <button class="status-btn pending" data-status="pending">Pending</button>
                                <button class="status-btn in-progress" data-status="in-progress">In Progress</button>
                                <button class="status-btn resolved" data-status="resolved">Resolved</button>
                                <button class="status-btn rejected" data-status="rejected">Rejected</button>
                            </div>
                            
                            <h4>Add Note</h4>
                            <textarea id="reportNoteText" placeholder="Add a note about this report..."></textarea>
                            <button id="addNoteBtn" class="btn primary-btn">Add Note</button>
                            
                            <div class="report-notes">
                                <h4>Notes History</h4>
                                <div id="reportNotesHistory" class="notes-history">
                                    <p class="no-notes">No notes added yet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Log Section removed as requested -->

            <!-- Staff Notes Section -->
            <section id="staff-notes" class="dashboard-section">
                <h2>Staff Notes</h2>
                <div class="notes-container">
                    <div class="add-note-form">
                        <h3>Add New Note</h3>
                        <div class="form-group">
                            <label for="noteTitle">Title</label>
                            <input type="text" id="noteTitle" placeholder="Note title...">
                        </div>
                        <div class="form-group">
                            <label for="noteContent">Content</label>
                            <textarea id="noteContent" rows="5" placeholder="Write your note here..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="noteVisibility">Visibility</label>
                            <select id="noteVisibility">
                                <option value="all">All Staff</option>
                                <option value="moderators">Moderators Only</option>
                                <option value="admins">Admins & Up</option>
                                <option value="management">Management & Founders</option>
                                <option value="private">Private (Only Me)</option>
                            </select>
                        </div>
                        <button id="addStaffNoteBtn" class="btn primary-btn">Save Note</button>
                    </div>

                    <div class="notes-list-container">
                        <h3>Your Notes</h3>
                        <div class="notes-list" id="staffNotesList">
                            <!-- Notes will be loaded here -->
                            <div class="note-card">
                                <div class="note-header">
                                    <h4 class="note-title">Welcome to Staff Dashboard</h4>
                                    <span class="note-date">Today</span>
                                </div>
                                <div class="note-body">
                                    <p>This is your staff notes section. You can add personal notes or share them with other staff members based on visibility settings.</p>
                                </div>
                                <div class="note-footer">
                                    <span class="note-visibility">
                                        <i class="fas fa-eye"></i> Private
                                    </span>
                                    <div class="note-actions">
                                        <button class="edit-note"><i class="fas fa-edit"></i></button>
                                        <button class="delete-note"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Admin Panel Section -->
            <section id="admin" class="dashboard-section">
                <h2>Admin Panel</h2>
                <div class="admin-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>This section is only available to administrators, management, and founders.</p>
                </div>

                <div class="admin-tabs">
                    <button class="admin-tab active" data-tab="user-management">User Management</button>
                    <button class="admin-tab" data-tab="site-settings">Site Settings</button>
                    <button class="admin-tab" data-tab="logs">System Logs</button>
                </div>

                <div class="admin-tab-content active" id="user-management">
                    <h3>User Management</h3>
                    <div class="user-management-tools">
                        <button class="btn secondary-btn" id="addUserBtn">
                            <i class="fas fa-user-plus"></i> Add New User
                        </button>
                        <div class="search-group">
                            <input type="text" id="userSearch" placeholder="Search users...">
                            <button id="userSearchBtn"><i class="fas fa-search"></i></button>
                        </div>
                    </div>

                    <div class="users-table-container">
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Last Login</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Users will be loaded here -->
                                <tr>
                                    <td>mod_user</td>
                                    <td>Moderator</td>
                                    <td>Today</td>
                                    <td><span class="status-badge active">Active</span></td>
                                    <td>
                                        <button class="action-btn edit-user"><i class="fas fa-edit"></i></button>
                                        <button class="action-btn reset-password"><i class="fas fa-key"></i></button>
                                        <button class="action-btn disable-user"><i class="fas fa-ban"></i></button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>admin_user</td>
                                    <td>Administrator</td>
                                    <td>Today</td>
                                    <td><span class="status-badge active">Active</span></td>
                                    <td>
                                        <button class="action-btn edit-user"><i class="fas fa-edit"></i></button>
                                        <button class="action-btn reset-password"><i class="fas fa-key"></i></button>
                                        <button class="action-btn disable-user"><i class="fas fa-ban"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="admin-tab-content" id="site-settings">
                    <h3>Site Settings</h3>
                    <div class="settings-form">
                        <div class="form-group">
                            <label for="siteName">Site Name</label>
                            <input type="text" id="siteName" value="UKBRUM Roleplay">
                        </div>
                        <div class="form-group">
                            <label for="siteDescription">Site Description</label>
                            <textarea id="siteDescription" rows="3">United Kingdom Birmingham Roleplay Community</textarea>
                        </div>
                        <div class="form-group">
                            <label for="discordLink">Discord Invite Link</label>
                            <input type="text" id="discordLink" value="https://discord.gg/ukbrum">
                        </div>
                        <div class="form-group">
                            <label for="gameCode">Game Code</label>
                            <input type="text" id="gameCode" value="UKBRUM">
                        </div>
                        <div class="form-group">
                            <label>Maintenance Mode</label>
                            <div class="toggle-switch">
                                <input type="checkbox" id="maintenanceMode">
                                <label for="maintenanceMode"></label>
                            </div>
                        </div>
                        <button class="btn primary-btn" id="saveSettingsBtn">Save Settings</button>
                    </div>
                </div>

                <div class="admin-tab-content" id="logs">
                    <h3>System Logs</h3>
                    <div class="logs-container">
                        <div class="log-filters">
                            <div class="filter-group">
                                <label for="logTypeFilter">Type:</label>
                                <select id="logTypeFilter">
                                    <option value="all">All Logs</option>
                                    <option value="system">System</option>
                                    <option value="security">Security</option>
                                    <option value="error">Errors</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="logDateFilter">Date:</label>
                                <select id="logDateFilter">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                </select>
                            </div>
                        </div>
                        <div class="logs-list" id="systemLogsList">
                            <!-- Logs will be loaded here -->
                            <div class="log-item">
                                <span class="log-time">Today 12:30 PM</span>
                                <span class="log-type system">SYSTEM</span>
                                <span class="log-message">System started successfully</span>
                            </div>
                            <div class="log-item">
                                <span class="log-time">Today 12:31 PM</span>
                                <span class="log-type security">SECURITY</span>
                                <span class="log-message">User admin_user logged in</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Function to update report status
        async function updateReportStatus(reportId, newStatus) {
            try {
                const response = await fetch('../api/update-report-status.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reportId: reportId,
                        status: newStatus,
                        user: sessionStorage.getItem('staffUser')
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update report status');
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error updating report status:', error);
                throw error;
            }
        }
        
        // Function to add note to report
        async function addReportNote(reportId, noteText) {
            try {
                const response = await fetch('../api/add-report-note.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reportId: reportId,
                        text: noteText,
                        author: sessionStorage.getItem('staffUser')
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to add note');
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error adding note:', error);
                throw error;
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is logged in
            const loggedInUser = sessionStorage.getItem('staffUser');
            const loggedInRole = sessionStorage.getItem('staffRole');
            
            if (!loggedInUser || !loggedInRole) {
                // Redirect to login page if not logged in
                window.location.href = '../info.html#login-section';
                return;
            }
            
            // Redirect to new dashboard
            window.location.href = 'new-dashboard.html';
            
            // Set user info in header
            document.getElementById('userName').textContent = loggedInUser;
            document.getElementById('userRole').textContent = capitalizeFirstLetter(loggedInRole);
            
            // Show admin section for admin, management, and founder roles
            if (['admin', 'management', 'founder'].includes(loggedInRole)) {
                document.getElementById('adminSection').style.display = 'block';
            }
            
            // Navigation
            const navLinks = document.querySelectorAll('.sidebar-nav a');
            const sections = document.querySelectorAll('.dashboard-section');
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Remove active class from all links and sections
                    navLinks.forEach(l => l.parentElement.classList.remove('active'));
                    sections.forEach(s => s.classList.remove('active'));
                    
                    // Add active class to clicked link
                    link.parentElement.classList.add('active');
                    
                    // Show corresponding section
                    const sectionId = link.getAttribute('data-section');
                    document.getElementById(sectionId).classList.add('active');
                });
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', () => {
                sessionStorage.removeItem('staffUser');
                sessionStorage.removeItem('staffRole');
                window.location.href = '../index.html';
            });
            
            // Load data from JSON files
            loadReportsData();
            loadActivityLogs();
            loadStaffUsers();
            loadStaffNotes();
            
            // Report modal functionality
            const reportModal = document.getElementById('reportModal');
            const closeModal = document.querySelector('.close-modal');
            
            // Close modal when clicking the X
            closeModal.addEventListener('click', () => {
                reportModal.style.display = 'none';
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === reportModal) {
                    reportModal.style.display = 'none';
                }
            });
            
            // Admin tabs
            const adminTabs = document.querySelectorAll('.admin-tab');
            const adminTabContents = document.querySelectorAll('.admin-tab-content');
            
            adminTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and contents
                    adminTabs.forEach(t => t.classList.remove('active'));
                    adminTabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Show corresponding content
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Add staff note
            document.getElementById('addStaffNoteBtn').addEventListener('click', () => {
                const title = document.getElementById('noteTitle').value;
                const content = document.getElementById('noteContent').value;
                const visibility = document.getElementById('noteVisibility').value;
                
                if (!title || !content) {
                    alert('Please fill in both title and content fields.');
                    return;
                }
                
                // Save staff note
                saveStaffNote(title, content, visibility)
                    .then(response => {
                        // Add the new note to the list
                        const notesList = document.getElementById('staffNotesList');
                        
                        const noteCard = document.createElement('div');
                        noteCard.className = 'note-card';
                        noteCard.innerHTML = `
                            <div class="note-header">
                                <h4 class="note-title">${title}</h4>
                                <span class="note-date">Just now</span>
                            </div>
                            <div class="note-body">
                                <p>${content}</p>
                            </div>
                            <div class="note-footer">
                                <span class="note-visibility">
                                    <i class="fas fa-eye"></i> ${capitalizeFirstLetter(visibility)}
                                </span>
                                <div class="note-actions">
                                    <button class="edit-note" data-id="${response.noteId}"><i class="fas fa-edit"></i></button>
                                    <button class="delete-note" data-id="${response.noteId}"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `;
                        
                        // Add to the beginning of the list
                        if (notesList.firstChild) {
                            notesList.insertBefore(noteCard, notesList.firstChild);
                        } else {
                            notesList.appendChild(noteCard);
                        }
                        
                        // Clear form
                        document.getElementById('noteTitle').value = '';
                        document.getElementById('noteContent').value = '';
                        
                        // Log activity
                        logActivity('note', 'Added new staff note: ' + title);
                    })
                    .catch(error => {
                        console.error('Error saving note:', error);
                        alert('Error saving note. Please try again.');
                    });
            });
            
            // Save site settings
            document.getElementById('saveSettingsBtn').addEventListener('click', () => {
                const siteName = document.getElementById('siteName').value;
                const siteDescription = document.getElementById('siteDescription').value;
                const discordLink = document.getElementById('discordLink').value;
                const maintenanceMode = document.getElementById('maintenanceMode').checked;
                
                // Save settings via API
                fetch('../api/toggle-maintenance-mode.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        enabled: maintenanceMode,
                        user: sessionStorage.getItem('staffUser'),
                        role: sessionStorage.getItem('staffRole')
                    })
                })
                .then(response => response.json())
                .then(data => {
                    alert('Settings saved successfully!');
                })
                .catch(error => {
                    console.error('Error saving settings:', error);
                    alert('Error saving settings. Please try again.');
                });
            });
        });
        
        // Helper function to capitalize first letter
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // Load reports data from JSON file
        function loadReportsData() {
            // In a real implementation, this would fetch from a server
            // For this demo, we'll use the reports.json file directly
            fetch('../data/reports.json')
                .then(response => response.json())
                .then(data => {
                    const reports = data.reports;
                    
                    // Update counts
                    document.getElementById('reportsCount').textContent = reports.length;
                    document.getElementById('pendingReportsCount').textContent = reports.filter(r => r.status === 'pending').length;
                    document.getElementById('resolvedReportsCount').textContent = reports.filter(r => r.status === 'resolved').length;
                    
                    // Populate reports table
                    const tableBody = document.getElementById('reportsTableBody');
                    tableBody.innerHTML = '';
                    
                    if (reports.length === 0) {
                        tableBody.innerHTML = `<tr class="no-reports-row"><td colspan="7">No reports found</td></tr>`;
                        return;
                    }
                    
                    reports.forEach(report => {
                        // Format date
                        const reportDate = new Date(report.timestamp);
                        const formattedDate = reportDate.toLocaleDateString();
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${report.id}</td>
                            <td>${capitalizeFirstLetter(report.type)}</td>
                            <td>${report.title}</td>
                            <td>${report.username}</td>
                            <td>${formattedDate}</td>
                            <td><span class="status-badge ${report.status}">${capitalizeFirstLetter(report.status)}</span></td>
                            <td>
                                <button class="action-btn view-report" data-id="${report.id}"><i class="fas fa-eye"></i></button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // Add event listeners to view buttons
                    document.querySelectorAll('.view-report').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const reportId = btn.getAttribute('data-id');
                            const report = reports.find(r => r.id === reportId);
                            
                            if (report) {
                                // Format date
                                const reportDate = new Date(report.timestamp);
                                const formattedDate = reportDate.toLocaleDateString() + ' ' + reportDate.toLocaleTimeString();
                                
                                // Populate modal with report data
                                document.getElementById('modalReportTitle').textContent = report.title;
                                document.getElementById('modalReportId').textContent = report.id;
                                document.getElementById('modalReportType').textContent = capitalizeFirstLetter(report.type);
                                document.getElementById('modalReportUser').textContent = report.username;
                                document.getElementById('modalReportDiscord').textContent = report.discordTag;
                                document.getElementById('modalReportDate').textContent = formattedDate;
                                document.getElementById('modalReportStatus').textContent = capitalizeFirstLetter(report.status);
                                document.getElementById('modalReportDetails').textContent = report.details;
                                
                                if (report.evidence) {
                                    document.getElementById('modalReportEvidence').innerHTML = `<a href="${report.evidence}" target="_blank">${report.evidence}</a>`;
                                } else {
                                    document.getElementById('modalReportEvidence').textContent = 'No evidence provided';
                                }
                                
                                // Populate notes history
                                const notesHistory = document.getElementById('reportNotesHistory');
                                notesHistory.innerHTML = '';
                                
                                if (report.notes && report.notes.length > 0) {
                                    report.notes.forEach(note => {
                                        const noteDate = new Date(note.timestamp);
                                        const formattedNoteDate = noteDate.toLocaleDateString() + ' ' + noteDate.toLocaleTimeString();
                                        
                                        const noteElement = document.createElement('div');
                                        noteElement.className = 'note-item';
                                        noteElement.innerHTML = `
                                            <p class="note-text">${note.text}</p>
                                            <div class="note-meta">
                                                <span class="note-author">${note.author}</span>
                                                <span class="note-time">${formattedNoteDate}</span>
                                            </div>
                                        `;
                                        
                                        notesHistory.appendChild(noteElement);
                                    });
                                } else {
                                    notesHistory.innerHTML = '<p class="no-notes">No notes added yet</p>';
                                }
                                
                                // Show modal
                                document.getElementById('reportModal').style.display = 'block';
                                
                                // Add event listeners to status buttons
                                document.querySelectorAll('.status-btn').forEach(statusBtn => {
                                    statusBtn.addEventListener('click', () => {
                                        const newStatus = statusBtn.getAttribute('data-status');
                                        document.getElementById('modalReportStatus').textContent = capitalizeFirstLetter(newStatus);
                                        
                                        // Update the report status in the JSON file
                                        updateReportStatus(report.id, newStatus)
                                            .then(() => {
                                                // Update status in table
                                                const statusCell = btn.closest('tr').querySelector('.status-badge');
                                                statusCell.className = `status-badge ${newStatus}`;
                                                statusCell.textContent = capitalizeFirstLetter(newStatus);
                                                
                                                // Update counts
                                                loadReportsData();
                                            })
                                            .catch(error => {
                                                console.error('Error updating report status:', error);
                                                alert('Error updating report status. Please try again.');
                                            });
                                        
                                        // Log activity
                                        logActivity('report', `Updated status of report ${report.id} to '${newStatus}'`);
                                    });
                                });
                                
                                // Add note button
                                document.getElementById('addNoteBtn').addEventListener('click', () => {
                                    const noteText = document.getElementById('reportNoteText').value;
                                    
                                    if (!noteText) {
                                        alert('Please enter a note.');
                                        return;
                                    }
                                    
                                    // Add note to the report in the JSON file
                                    addReportNote(report.id, noteText)
                                        .then(() => {
                                            const notesHistory = document.getElementById('reportNotesHistory');
                                            
                                            // Remove 'no notes' message if it exists
                                            const noNotes = notesHistory.querySelector('.no-notes');
                                            if (noNotes) {
                                                notesHistory.innerHTML = '';
                                            }
                                            
                                            const noteElement = document.createElement('div');
                                            noteElement.className = 'note-item';
                                            noteElement.innerHTML = `
                                                <p class="note-text">${noteText}</p>
                                                <div class="note-meta">
                                                    <span class="note-author">${sessionStorage.getItem('staffUser')}</span>
                                                    <span class="note-time">Just now</span>
                                                </div>
                                            `;
                                            
                                            notesHistory.appendChild(noteElement);
                                            
                                            // Clear textarea
                                            document.getElementById('reportNoteText').value = '';
                                        })
                                        .catch(error => {
                                            console.error('Error adding note:', error);
                                            alert('Error adding note. Please try again.');
                                        });
                                    
                                    // Log activity
                                    logActivity('note', `Added note to report ${report.id}`);
                                });
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading reports:', error);
                    document.getElementById('reportsTableBody').innerHTML = `<tr class="no-reports-row"><td colspan="7">Error loading reports</td></tr>`;
                });
        }
        
        // Load activity logs from JSON file
        function loadActivityLogs() {
            // In a real implementation, this would fetch from a server
            // For this demo, we'll use the activity-logs.json file directly
            fetch('../data/activity-logs.json')
                .then(response => response.json())
                .then(data => {
                    const logs = data.logs;
                    
                    // Update count
                    document.getElementById('activityLogsCount').textContent = logs.length;
                    
                    // Populate activity log list
                    const activityLogList = document.getElementById('activityLogList');
                    activityLogList.innerHTML = '';
                    
                    // Add current login activity
                    const currentLoginElement = document.createElement('div');
                    currentLoginElement.className = 'activity-item';
                    currentLoginElement.innerHTML = `
                        <div class="activity-icon">
                            <i class="fas fa-sign-in-alt"></i>
                        </div>
                        <div class="activity-details">
                            <p class="activity-text">You logged into the staff dashboard</p>
                            <p class="activity-time">Just now</p>
                        </div>
                    `;
                    activityLogList.appendChild(currentLoginElement);
                    
                    // Add recent activities (limit to 10)
                    const recentLogs = logs.slice(0, 10);
                    recentLogs.forEach(log => {
                        const logDate = new Date(log.timestamp);
                        const formattedDate = logDate.toLocaleDateString() + ' ' + logDate.toLocaleTimeString();
                        
                        let iconClass = 'fa-clipboard-list';
                        if (log.type === 'login') iconClass = 'fa-sign-in-alt';
                        if (log.type === 'report') iconClass = 'fa-flag';
                        if (log.type === 'note') iconClass = 'fa-sticky-note';
                        if (log.type === 'admin') iconClass = 'fa-user-shield';
                        
                        const logElement = document.createElement('div');
                        logElement.className = 'activity-item';
                        logElement.innerHTML = `
                            <div class="activity-icon">
                                <i class="fas ${iconClass}"></i>
                            </div>
                            <div class="activity-details">
                                <p class="activity-text">${log.user}: ${log.details}</p>
                                <p class="activity-time">${formattedDate}</p>
                            </div>
                        `;
                        activityLogList.appendChild(logElement);
                    });
                    
                    // Populate full activity log
                    const fullActivityLogList = document.getElementById('activityLogList');
                    if (fullActivityLogList) {
                        fullActivityLogList.innerHTML = activityLogList.innerHTML;
                    }
                })
                .catch(error => {
                    console.error('Error loading activity logs:', error);
                });
        }
        
        // Load staff users from JSON file
        function loadStaffUsers() {
            // In a real implementation, this would fetch from a server
            // For this demo, we'll use the staff-users.json file directly
            fetch('../data/staff-users.json')
                .then(response => response.json())
                .then(data => {
                    const users = data.users;
                    
                    // Update staff online count (just for demo purposes)
                    document.getElementById('staffOnlineCount').textContent = Math.floor(Math.random() * 3) + 1;
                    
                    // Populate users table if in admin section
                    const usersTableBody = document.getElementById('usersTableBody');
                    if (usersTableBody) {
                        usersTableBody.innerHTML = '';
                        
                        users.forEach(user => {
                            const lastLoginDate = new Date(user.lastLogin);
                            const formattedLastLogin = lastLoginDate.toLocaleDateString();
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${user.username}</td>
                                <td>${capitalizeFirstLetter(user.role)}</td>
                                <td>${formattedLastLogin}</td>
                                <td><span class="status-badge ${user.status}">${capitalizeFirstLetter(user.status)}</span></td>
                                <td>
                                    <button class="action-btn edit-user" data-username="${user.username}"><i class="fas fa-edit"></i></button>
                                    <button class="action-btn reset-password" data-username="${user.username}"><i class="fas fa-key"></i></button>
                                    <button class="action-btn ${user.status === 'active' ? 'disable-user' : 'enable-user'}" data-username="${user.username}">
                                        <i class="fas ${user.status === 'active' ? 'fa-ban' : 'fa-check'}"></i>
                                    </button>
                                </td>
                            `;
                            usersTableBody.appendChild(row);
                        });
                        
                        // Add event listeners to user action buttons
                        document.querySelectorAll('.edit-user').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const username = btn.getAttribute('data-username');
                                alert(`Edit user: ${username}\nIn a real implementation, this would open a user edit form.`);
                            });
                        });
                        
                        document.querySelectorAll('.reset-password').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const username = btn.getAttribute('data-username');
                                alert(`Reset password for: ${username}\nIn a real implementation, this would reset the user's password.`);
                            });
                        });
                        
                        document.querySelectorAll('.disable-user, .enable-user').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const username = btn.getAttribute('data-username');
                                const action = btn.classList.contains('disable-user') ? 'disable' : 'enable';
                                alert(`${capitalizeFirstLetter(action)} user: ${username}\nIn a real implementation, this would ${action} the user's account.`);
                            });
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading staff users:', error);
                });
        }
        
        // Log activity function
        function logActivity(type, details) {
            // In a real implementation, this would save to a database
            // For this demo, we'll just add it to the activity list
            const activityLogList = document.getElementById('recentActivityList');
            
            let iconClass = 'fa-clipboard-list';
            if (type === 'login') iconClass = 'fa-sign-in-alt';
            if (type === 'report') iconClass = 'fa-flag';
            if (type === 'note') iconClass = 'fa-sticky-note';
            if (type === 'admin') iconClass = 'fa-user-shield';
            
            const logElement = document.createElement('div');
            logElement.className = 'activity-item';
            logElement.innerHTML = `
                <div class="activity-icon">
                    <i class="fas ${iconClass}"></i>
                </div>
                <div class="activity-details">
                    <p class="activity-text">${details}</p>
                    <p class="activity-time">Just now</p>
                </div>
            `;
            
            // Insert at the beginning
            activityLogList.insertBefore(logElement, activityLogList.firstChild);
            
            // Also add to full activity log if it exists
            const fullActivityLogList = document.getElementById('activityLogList');
            if (fullActivityLogList && fullActivityLogList !== activityLogList) {
                const logElementCopy = logElement.cloneNode(true);
                fullActivityLogList.insertBefore(logElementCopy, fullActivityLogList.firstChild);
            }
        }
    </script>
</body>
</html>